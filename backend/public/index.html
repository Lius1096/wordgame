<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <title>Jeu de mots mÃ©langÃ©s</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
    }

    /* Animation grosse vibration */
    @keyframes big-shake {

      0%,
      100% {
        transform: translate(0, 0);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translate(-20px, 0);
      }

      20%,
      40%,
      60%,
      80% {
        transform: translate(20px, 0);
      }
    }

    .big-shake {
      animation: big-shake 0.8s ease-in-out;
    }

    /* Flash Ã©cran blanc plein Ã©cran */
    #flash-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    #flash-screen.active {
      opacity: 1;
      pointer-events: auto;
      transition: opacity 0.5s ease;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-6">

  <div id="flash-screen"></div> <!-- Flash Ã©cran -->

  <div class="w-full max-w-md bg-white rounded-lg shadow p-6">
    <div class="flex justify-between items-center mb-4">
      <h1 id="title" class="text-2xl font-bold">
        <i class="fas fa-font mr-1 text-blue-500"></i> Devine le mot mÃ©langÃ©
      </h1>
      <select onchange="changeLanguage(this.value)" class="text-sm border p-1 rounded">
        <option value="fr">ðŸ‡«ðŸ‡· FR</option>
        <option value="en">ðŸ‡¬ðŸ‡§ EN</option>
      </select>
    </div>

    <p class="text-gray-600 text-sm mb-2" id="subtitle">Tu as 30 secondes pour rÃ©pondre.</p>
    <p class="mb-2"><i class="fas fa-book mr-1 text-purple-600"></i> <span id="category"
        class="font-semibold text-blue-600">...</span></p>
    <div id="scrambled" class="text-3xl font-mono mb-4 text-green-700 text-center">Chargement...</div>

    <input id="guess" type="text" placeholder="Ta rÃ©ponse" class="w-full p-2 border rounded mb-2" />
    <button onclick="checkAnswer()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      <i class="fas fa-check mr-1"></i> VÃ©rifier
    </button>

    <div class="mt-4 text-center text-sm text-gray-500">
      <i class="fas fa-stopwatch mr-1 text-red-500"></i>
      <span id="timer-label">Temps restant</span> : <span id="timer" class="font-bold text-red-600">30</span>s
    </div>

    <!-- Tentatives restantes -->
    <div class="mt-2 text-sm text-red-600 text-center">
      <i class="fas fa-times mr-1 text-red-500"></i>
      Tentatives restantes : <span id="attempts">3</span>
    </div>

    <div id="result" class="mt-3 text-center font-semibold text-lg"></div>
    <div id="hint" class="text-xs text-gray-500 italic text-center mt-2"></div>

    <div class="mt-4 flex justify-between items-center">
      <button onclick="setupGame()" id="new-game-btn" class="text-sm text-gray-600 underline">
        <i class="fas fa-redo mr-1"></i> Nouvelle devinette
      </button>
      <div class="text-sm font-medium text-green-700" id="score-label">
        <i class="fas fa-star mr-1 text-yellow-500"></i> Score : <span id="score">0</span>
      </div>
    </div>

    <div class="mt-4">
      <input type="text" id="username" placeholder="Ton prÃ©nom" class="w-full p-2 border rounded text-sm" />
    </div>
  </div>

  <script>
    const categories = {
      fr: {
        "Fruits": "fruit",
        "Sports": "sport",
        "Culture": "culture",
        "Langue": "langue",
        "Pays": "pays",
        "Ville": "ville"
      },
      en: {
        "Fruits": "fruit",
        "Sports": "sport",
        "Culture": "culture",
        "Language": "language",
        "Country": "country",
        "City": "city"
      }
    };

    const translations = {
      fr: {
        title: "<i class='fas fa-font mr-1 text-blue-500'></i> Devine le mot mÃ©langÃ©",
        subtitle: "Tu as 30 secondes pour rÃ©pondre.",
        timerLabel: "Temps restant",
        goodAnswer: "<i class='fas fa-check-circle text-green-600 mr-1'></i> Bonne rÃ©ponse !",
        wrongAnswer: "<i class='fas fa-times-circle text-red-600 mr-1'></i> Mauvaise rÃ©ponse.",
        timeOut: "<i class='fas fa-stopwatch text-red-600 mr-1'></i> Temps Ã©coulÃ© ! Le mot Ã©tait : ",
        newGame: "<i class='fas fa-redo mr-1'></i> Nouvelle devinette",
        score: "<i class='fas fa-star mr-1 text-yellow-500'></i> Score",
        loading: "Chargement...",
        noWord: " Aucun mot trouvÃ©.",
        adrenalineMessage: "Waoooh, vous Ãªtes presque lÃ  ! Une surprise vous attend...",
        failedMessage: "<i class='fas fa-thumbs-down text-red-600 mr-1'></i> RatÃ© ! Le mot Ã©tait : "
      },
      en: {
        title: "<i class='fas fa-font mr-1 text-blue-500'></i> Guess the Scrambled Word",
        subtitle: "You have 30 seconds to answer.",
        timerLabel: "Time left",
        goodAnswer: "<i class='fas fa-check-circle text-green-600 mr-1'></i> Correct!",
        wrongAnswer: "<i class='fas fa-times-circle text-red-600 mr-1'></i> Incorrect.",
        timeOut: "<i class='fas fa-stopwatch text-red-600 mr-1'></i> Time's up! The word was: ",
        newGame: "<i class='fas fa-redo mr-1'></i> New word",
        score: "<i class='fas fa-star mr-1 text-yellow-500'></i> Score",
        loading: "Loading...",
        noWord: " No word found.",
        adrenalineMessage: "ðŸ”¥ Feel the adrenaline rush! Keep it up! ðŸ”¥",
        failedMessage: "<i class='fas fa-thumbs-down text-red-600 mr-1'></i> Failed! The word was: "
      }
    };

    let currentLang = "fr";
    let currentWord = "";
    let timer = 30;
    let score = 0;
    let attempts = 3;
    let timerInterval;

    function changeLanguage(lang) {
      currentLang = lang;
      const t = translations[lang];
      document.getElementById("title").innerHTML = t.title;
      document.getElementById("subtitle").innerText = t.subtitle;
      document.getElementById("timer-label").innerText = t.timerLabel;
      document.getElementById("new-game-btn").innerHTML = t.newGame;
      document.getElementById("score-label").innerHTML = `${t.score} : <span id="score">${score}</span>`;
      document.getElementById("result").innerText = "";
      document.getElementById("hint").innerText = "";
      setupGame();
    }

    function scramble(word) {
      return word.split('').sort(() => Math.random() - 0.5).join('');
    }

    function resetTimer() {
      clearInterval(timerInterval);
      timer = 30;
      document.getElementById("timer").innerText = timer;
      timerInterval = setInterval(() => {
        timer--;
        document.getElementById("timer").innerText = timer;
        if (timer <= 0) {
          clearInterval(timerInterval);
          const t = translations[currentLang];
          document.getElementById("result").innerHTML = t.timeOut + currentWord;
          // Passe au mot suivant aprÃ¨s dÃ©lai
          setTimeout(setupGame, 3000);
        }
      }, 1000);
    }

    async function getRandomWordByCategory(keyword) {
      if (currentLang === "fr") {
        return await getRandomFrenchWord(keyword);
      }
      try {
        const res = await fetch(`https://api.datamuse.com/words?ml=${keyword}&max=50`);
        const data = await res.json();
        const filtered = data.filter(w => !w.word.includes(' ') && w.word.length >= 4 && w.word.length <= 10);
        if (!filtered.length) return null;
        const random = filtered[Math.floor(Math.random() * filtered.length)];
        return { word: random.word.toLowerCase(), hint: await getHint(random.word.toLowerCase()) };
      } catch (err) {
        console.error("Erreur API Datamuse :", err);
        return null;
      }
    }

    async function getRandomFrenchWord(keyword) {
      try {
        const res = await fetch(`http://localhost:3000/api/french-words/random?category=${keyword}`);
        const data = await res.json();
        if (!data?.word) return null;
        return { word: data.word.toLowerCase(), hint: data.hint || "" };
      } catch (err) {
        console.error("Erreur API locale franÃ§aise :", err);
        return null;
      }
    }

    async function getHint(word) {
      const res = await fetch(`https://api.datamuse.com/words?sp=${word}&md=d`);
      const data = await res.json();
      return data[0]?.defs?.[0]?.split("\t")[1] || "";
    }

    async function setupGame() {
      clearInterval(timerInterval);
      const t = translations[currentLang];
      const langCategories = categories[currentLang];
      const categoryNames = Object.keys(langCategories);
      const selectedCategory = categoryNames[Math.floor(Math.random() * categoryNames.length)];
      const keyword = langCategories[selectedCategory];

      document.getElementById("category").innerText = selectedCategory;
      document.getElementById("result").innerText = "";
      document.getElementById("hint").innerText = "";
      document.getElementById("guess").value = "";
      document.getElementById("scrambled").innerText = t.loading;

      const result = await getRandomWordByCategory(keyword);
      if (!result || !result.word) {
        document.getElementById("scrambled").innerText = t.noWord;
        return;
      }

      currentWord = result.word;
      attempts = 3;
      document.getElementById("attempts").innerText = attempts;
      document.getElementById("scrambled").innerText = scramble(currentWord).toUpperCase();

      if (result.hint && currentLang === "en") {
        document.getElementById("hint").innerHTML = "<i class='fas fa-lightbulb mr-1'></i>" + result.hint;
      }

      resetTimer();
    }

    async function checkAnswer() {
      const guess = document.getElementById("guess").value.trim().toLowerCase();
      const result = document.getElementById("result");
      const t = translations[currentLang];

      if (guess === currentWord) {
        clearInterval(timerInterval);
        score++;
        document.getElementById("score").innerText = score;
        result.innerHTML = t.goodAnswer;

        if (score === 10) {
          launchConfetti();
        }

        // Message adrÃ©naline Ã  18 et 19 points
        if (score === 18 || score === 19) {
          showAdrenalineMessage();
        }

        if (score === 20) {
          launchConfetti("gold");
          bigVibration();
          flashScreen();
        }

        await saveScore();

        // Passe Ã  la devinette suivante aprÃ¨s un court dÃ©lai
        setTimeout(setupGame, 2000);
      } else {
        attempts--;
        document.getElementById("attempts").innerText = attempts;
        if (attempts > 0) {
          result.innerHTML = t.wrongAnswer;
        } else {
          clearInterval(timerInterval);
          result.innerHTML = translations[currentLang].failedMessage + currentWord;
          document.getElementById("hint").innerText = "ðŸ’¡ Ne baisse jamais les bras, un autre mot arrive...";
          setTimeout(setupGame, 3000);
        }
      }
    }

    function bigVibration() {
      if (navigator.vibrate) {
        navigator.vibrate([300, 200, 300, 200, 500]);
      }
      document.body.classList.add("big-shake");
      setTimeout(() => {
        document.body.classList.remove("big-shake");
      }, 800);
    }

    function launchConfetti(color = null) {
      confetti({
        particleCount: 150,
        spread: 100,
        origin: { y: 0.6 },
        colors: color ? [color, "#FFD700", "#FF4500"] : undefined
      });
      setTimeout(() => {
        confetti({
          particleCount: 100,
          spread: 70,
          origin: { y: 0.6 },
          colors: color ? [color, "#FFD700", "#FF4500"] : undefined
        });
      }, 1000);
    }

    function showAdrenalineMessage() {
      const result = document.getElementById("result");
      result.innerHTML = `<i class="fas fa-bolt text-yellow-600 mr-1"></i> ${translations[currentLang].adrenalineMessage}`;
    }

    function flashScreen() {
      const flash = document.getElementById("flash-screen");
      flash.classList.add("active");
      setTimeout(() => {
        flash.classList.remove("active");
      }, 300);
    }

    async function saveScore() {
      const username = document.getElementById("username").value.trim() || "Anonyme";
      try {
        await fetch("http://localhost:3000/api/scores", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, score, language: currentLang })
        });
      } catch (err) {
        console.warn("Erreur lors de l'enregistrement du score :", err);
      }
    }

    setupGame();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</body>

</html>