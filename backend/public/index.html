<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Jeu de mots m√©lang√©s</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { font-family: 'Segoe UI', sans-serif; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-6">

  <div class="w-full max-w-md bg-white rounded-lg shadow p-6">
    <div class="flex justify-between items-center mb-4">
      <h1 id="title" class="text-2xl font-bold">
        <i class="fas fa-font mr-1 text-blue-500"></i> Devine le mot m√©lang√©
      </h1>
      <select onchange="changeLanguage(this.value)" class="text-sm border p-1 rounded">
        <option value="fr">üá´üá∑ FR</option>
        <option value="en">üá¨üáß EN</option>
      </select>
    </div>

    <p class="text-gray-600 text-sm mb-2" id="subtitle">Tu as 30 secondes pour r√©pondre.</p>
    <p class="mb-2"><i class="fas fa-book mr-1 text-purple-600"></i> <span id="category" class="font-semibold text-blue-600">...</span></p>
    <div id="scrambled" class="text-3xl font-mono mb-4 text-green-700 text-center">Chargement...</div>

    <input id="guess" type="text" placeholder="Ta r√©ponse" class="w-full p-2 border rounded mb-2" />
    <button onclick="checkAnswer()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
      <i class="fas fa-check mr-1"></i> V√©rifier
    </button>

    <div class="mt-4 text-center text-sm text-gray-500">
      <i class="fas fa-stopwatch mr-1 text-red-500"></i>
      <span id="timer-label">Temps restant</span> : <span id="timer" class="font-bold text-red-600">30</span>s
    </div>

    <div id="result" class="mt-3 text-center font-semibold text-lg"></div>
    <div id="hint" class="text-xs text-gray-500 italic text-center mt-2"></div>

    <div class="mt-4 flex justify-between items-center">
      <button onclick="setupGame()" id="new-game-btn" class="text-sm text-gray-600 underline">
        <i class="fas fa-redo mr-1"></i> Nouvelle devinette
      </button>
      <div class="text-sm font-medium text-green-700" id="score-label">
        <i class="fas fa-star mr-1 text-yellow-500"></i> Score : <span id="score">0</span>
      </div>
    </div>

    <div class="mt-4">
      <input type="text" id="username" placeholder="Ton pr√©nom" class="w-full p-2 border rounded text-sm" />
    </div>
  </div>

  <script>
    const categories = {
      fr: {
        "Fruits": "fruit",
        "Sports": "sport",
        "Culture": "culture",
        "Langue": "langue",
        "Pays": "pays",
        "Ville": "ville"
      },
      en: {
        "Fruits": "fruit",
        "Sports": "sport",
        "Culture": "culture",
        "Language": "language",
        "Country": "country",
        "City": "city"
      }
    };

    const translations = {
      fr: {
        title: "<i class='fas fa-font mr-1 text-blue-500'></i> Devine le mot m√©lang√©",
        subtitle: "Tu as 30 secondes pour r√©pondre.",
        timerLabel: "Temps restant",
        goodAnswer: "<i class='fas fa-check-circle text-green-600 mr-1'></i> Bonne r√©ponse !",
        wrongAnswer: "<i class='fas fa-times-circle text-red-600 mr-1'></i> Mauvaise r√©ponse.",
        timeOut: "<i class='fas fa-stopwatch text-red-600 mr-1'></i> Temps √©coul√© ! Le mot √©tait : ",
        newGame: "<i class='fas fa-redo mr-1'></i> Nouvelle devinette",
        score: "<i class='fas fa-star mr-1 text-yellow-500'></i> Score",
        loading: "Chargement...",
        noWord: " Aucun mot trouv√©."
      },
      en: {
        title: "<i class='fas fa-font mr-1 text-blue-500'></i> Guess the Scrambled Word",
        subtitle: "You have 30 seconds to answer.",
        timerLabel: "Time left",
        goodAnswer: "<i class='fas fa-check-circle text-green-600 mr-1'></i> Correct!",
        wrongAnswer: "<i class='fas fa-times-circle text-red-600 mr-1'></i> Incorrect.",
        timeOut: "<i class='fas fa-stopwatch text-red-600 mr-1'></i> Time's up! The word was: ",
        newGame: "<i class='fas fa-redo mr-1'></i> New word",
        score: "<i class='fas fa-star mr-1 text-yellow-500'></i> Score",
        loading: "Loading...",
        noWord: " No word found."
      }
    };

    let currentLang = "fr";
    let currentWord = "";
    let timer = 30;
    let score = 0;
    let timerInterval;

    function changeLanguage(lang) {
      currentLang = lang;
      const t = translations[lang];
      document.getElementById("title").innerHTML = t.title;
      document.getElementById("subtitle").innerText = t.subtitle;
      document.getElementById("timer-label").innerText = t.timerLabel;
      document.getElementById("new-game-btn").innerHTML = t.newGame;
      document.getElementById("score-label").innerHTML = `${t.score} : <span id="score">${score}</span>`;
      document.getElementById("result").innerText = "";
      document.getElementById("hint").innerText = "";
      setupGame();
    }

    function scramble(word) {
      return word.split('').sort(() => Math.random() - 0.5).join('');
    }

    function resetTimer() {
      clearInterval(timerInterval);
      timer = 30;
      document.getElementById("timer").innerText = timer;
      timerInterval = setInterval(() => {
        timer--;
        document.getElementById("timer").innerText = timer;
        if (timer <= 0) {
          clearInterval(timerInterval);
          document.getElementById("result").innerHTML = translations[currentLang].timeOut + currentWord;
        }
      }, 1000);
    }

    async function getRandomWordByCategory(keyword) {
      if (currentLang === "fr") {
        return await getRandomFrenchWord(keyword);
      }

      try {
        const res = await fetch(`https://api.datamuse.com/words?ml=${keyword}&max=50`);
        const data = await res.json();
        const filtered = data.filter(w => !w.word.includes(' ') && w.word.length >= 4 && w.word.length <= 10);
        if (!filtered.length) return null;
        const random = filtered[Math.floor(Math.random() * filtered.length)];
        return { word: random.word.toLowerCase(), hint: await getHint(random.word.toLowerCase()) };
      } catch (err) {
        console.error("Erreur API Datamuse :", err);
        return null;
      }
    }

    async function getRandomFrenchWord(keyword) {
      try {
        const res = await fetch(`http://localhost:3000/api/french-words/random?category=${keyword}`);
        const data = await res.json();
        if (!data?.word) return null;
        return { word: data.word.toLowerCase(), hint: data.hint || "" };
      } catch (err) {
        console.error("Erreur API locale fran√ßaise :", err);
        return null;
      }
    }

    async function getHint(word) {
      const res = await fetch(`https://api.datamuse.com/words?sp=${word}&md=d`);
      const data = await res.json();
      return data[0]?.defs?.[0]?.split("\t")[1] || "";
    }

    async function setupGame() {
      clearInterval(timerInterval);
      const t = translations[currentLang];
      const langCategories = categories[currentLang];
      const categoryNames = Object.keys(langCategories);
      const selectedCategory = categoryNames[Math.floor(Math.random() * categoryNames.length)];
      const keyword = langCategories[selectedCategory];

      document.getElementById("category").innerText = selectedCategory;
      document.getElementById("result").innerText = "";
      document.getElementById("hint").innerText = "";
      document.getElementById("guess").value = "";
      document.getElementById("scrambled").innerText = t.loading;

      const result = await getRandomWordByCategory(keyword);
      if (!result || !result.word) {
        document.getElementById("scrambled").innerText = t.noWord;
        return;
      }

      currentWord = result.word;
      document.getElementById("scrambled").innerText = scramble(currentWord).toUpperCase();

      if (result.hint && currentLang === "en") {
        document.getElementById("hint").innerHTML = "<i class='fas fa-lightbulb mr-1'></i>" + result.hint;
      }

      resetTimer();
    }

    async function checkAnswer() {
      const guess = document.getElementById("guess").value.trim().toLowerCase();
      const result = document.getElementById("result");
      const t = translations[currentLang];

      if (guess === currentWord) {
        clearInterval(timerInterval);
        score++;
        document.getElementById("score").innerText = score;
        result.innerHTML = t.goodAnswer;
        await saveScore();
      } else {
        result.innerHTML = t.wrongAnswer;
      }
    }

    async function saveScore() {
      const username = document.getElementById("username").value.trim() || "Anonyme";
      try {
        await fetch("http://localhost:3000/api/scores", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, score, language: currentLang })
        });
      } catch (err) {
        console.warn("Erreur lors de l'enregistrement du score :", err);
      }
    }

    setupGame();
  </script>
</body>
</html>
